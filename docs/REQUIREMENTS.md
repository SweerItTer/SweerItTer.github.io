# SweerItTer 博客需求与进度文档（单一真相源）

> 更新时间：2026-02-23
> 适用分支：`.worktrees/ux-refresh`
> 目标：后续开发只看这一份文档即可继续推进。

---

## 1. 项目目标

### 1.1 业务目标
- 将站点稳定为多页面结构：`welcome_page.html -> blog.html -> article.html?id=...`。
- 保持既有视觉风格与主要交互手感不变。
- 在 GitHub Pages 纯静态部署约束下，保证文章加载、目录导航、评论、统计可用。
- 提供用户可选风格：亮/暗模式 + 莫奈色盘；并全站生效。

### 1.2 非目标
- 不引入后端服务。
- 不引入数据库。
- 不改变欢迎页核心视觉语言。

---

## 2. 范围与页面职责

### 2.1 页面
- 欢迎页：品牌展示与入口跳转。
- 列表页：文章索引加载、搜索、排序、卡片跳转。
- 详情页：正文渲染、目录跟随、评论、统计、主题控制。

### 2.2 导航规则
- 欢迎页点击后进入列表页。
- 列表页点击文章卡片进入详情页并带 `id`。
- 详情页可返回列表页；列表页可返回欢迎页。

---

## 3. 功能需求（可测试）

### FR-001 文章索引加载
- 系统应优先读取 `articles/articles.index.json`。
- 若索引不可用，应回退到 GitHub API 拉取文章列表。
- 若 API 限流/失败，应回退到缓存与 `fallbackFiles`。

### FR-002 部署期索引生成
- 系统应在仓库提交/部署流程中生成 `articles/articles.index.json`。
- 终端访问不应依赖每次实时 API 请求。

### FR-003 列表页能力
- 系统应支持按关键字搜索标题、摘要、标签。
- 系统应支持按字母/日期排序。
- 系统应支持卡片点击跳转至详情页。

### FR-004 详情页目录（TOC）
- 系统应在左侧展示目录。
- 系统应在正文滚动时保持目录可见并高亮当前章节。
- 系统应支持目录折叠/展开与章节跳转。
- 系统应在目录隐藏后保持正文区域布局稳定。

### FR-005 主题系统
- 系统应提供全站统一的右上角齿轮设置面板。
- 系统应支持亮色/暗色切换。
- 系统应支持对应模式下的莫奈色盘选择。
- 系统应持久化用户选择并跨页面生效。
- 系统应在详情页支持 GitHub/Claude 文档渲染风格切换。

### FR-006 评论系统
- 系统应按文章 ID 隔离评论串（避免串文）。
- 当 Giscus 配置缺失时，系统应显示明确提示。

### FR-007 统计系统
- 系统应显示阅读量与访问人数。
- 系统应以文章维度隔离会话缓存值。

### FR-008 文档要求
- 系统文档应全中文、UTF-8 编码、可读无乱码。
- 需求、验收、进度应集中在本文件维护。

---

## 4. 非功能需求

### NFR-001 性能
- 列表初次可见应优先走静态索引，避免多次网络串行请求。
- 目录、统计、评论相关观察器应可回收，避免重复绑定导致性能劣化。

### NFR-002 可维护性
- 页面入口、功能模块、UI 组件应按目录分层。
- 重复工具函数（如日期格式化、HTML 转义）应抽象为共享 util。

### NFR-003 稳定性
- API 403/网络失败时不应出现空白页。
- 主题切换不应破坏既有布局与交互。

---

## 5. 当前进度（2026-02-23）

### 已完成
- 多页面结构落地（欢迎页/列表页/详情页）。
- 文章索引多级降级策略（静态索引 -> API -> 缓存 -> fallback）已接入。
- 目录基础能力可用（跟随、高亮、跳转、折叠）。
- 评论按文章 ID 映射（Giscus specific term）。
- 全站齿轮主题面板已接入，亮暗 + 色盘全局生效。
- 详情页文档渲染风格切换（GitHub/Claude）已接入。

### 进行中
- 亮色模式下部分细节对比度继续微调（局部边框/分隔线与背景接近）。
- 目录/统计相关观察器生命周期治理。

### 待办（高优先）
- 修复 `articles-source` 中 Markdown 摘要分行解析错误（见技术债 T-001）。
- 优化 GitHub API 分支下文章元信息读取性能（并发/批处理）。
- 抽离重复工具函数，降低脚本间重复实现。

---

## 6. 代码检查结论（性能与抽象）

### T-001（高）Markdown 摘要提取存在分行解析错误
- 文件：`scripts/features/articles-source.js:217`
- 现象：使用 `split(/\\r?\\n/)`，实际匹配的是反斜杠字符而非换行。
- 影响：摘要提取不稳定，可能把整段当成一行，影响列表描述质量。

### T-002（中）GitHub API 路径下元信息读取为串行 N 次请求
- 文件：`scripts/features/articles-source.js:91-103`
- 现象：`for...of` 内 `await fetchArticleContent` 串行执行。
- 影响：文章数量增大时列表首屏明显变慢。

### T-003（中）TOC 的 IntersectionObserver 未做生命周期回收
- 文件：`scripts/ui/toc.js:160-182`
- 现象：每次重建 TOC 都新建 observer，未显式 disconnect 旧 observer。
- 影响：长会话/频繁切文时可能有额外观察开销。

### T-004（中）统计锁值逻辑会创建长期 MutationObserver
- 文件：`scripts/features/analytics.js:79-94`
- 现象：`applyLockedValues` 的 observer 不断维持“强制写回”，无回收策略。
- 影响：有潜在额外开销，不利于后续可维护性。

### T-005（低）工具函数重复，抽象不足
- 文件：
  - `scripts/article.js:220-239`
  - `scripts/blog.js:172-186`
- 现象：日期格式化与 escapeHtml 在多个模块重复实现。
- 影响：规则变更时需多处同步，容易不一致。

### T-006（低）文档编码质量问题
- 文件：`docs/ACCEPTANCE_CHECKLIST.md`
- 现象：内容乱码，不满足文档可维护要求。
- 影响：后续接手难度上升，验收信息不可直接使用。

---

## 7. 下一阶段执行计划（建议）

1. 修复 T-001（1 个提交）
- 更正摘要分行正则，补最小回归样例。

2. 优化 T-002（1-2 个提交）
- 将串行元信息读取改为限流并发（如 4~6 并发）。

3. 治理 T-003/T-004（1 个提交）
- 为 TOC 与统计增加 observer 管理与销毁逻辑。

4. 处理 T-005（1 个提交）
- 新建 `scripts/utils/format.js`（日期、escapeHtml 等）。

5. 亮色可读性收尾（1 个提交）
- 按组件清单逐项对比检查并微调变量。

---

## 8. 验收基线（回归最小集）

1. 流程回归
- 欢迎页 -> 列表页 -> 详情页全链路正常。

2. 数据回归
- 正常索引可读；索引缺失时 API/缓存/fallback 生效。

3. 目录回归
- 左侧目录跟随可见；跳转高亮正确；折叠可用。

4. 主题回归
- 右上角齿轮在全站可用；亮/暗 + 色盘跨页保持。

5. 评论/统计回归
- 评论按文章隔离；统计不串值。

---

## 9. 变更维护规则

- 任何功能状态变更必须同步更新“第 5 节 当前进度”。
- 新增问题必须追加到“第 6 节 代码检查结论”并给出优先级。
- 删除历史文档后，不再维护平行版本需求文档。
